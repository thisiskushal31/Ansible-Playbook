---
- name: Ensure keyfile path is present or will be created
  stat:
    path: /etc/mongo.keyfile
  register: mongo_auth_key

- block:
    - name: Retrieve replica set key from Google Secret Manager
      shell: |
        gcloud secrets versions access latest --project={{gcp_project}} --secret={{mongo_key_auth_secret}}
      register: fetch_secret_result
      changed_when: true
      no_log: false

    - name: Log gcloud failure details
      debug:
        msg: "gcloud exited with {{ fetch_secret_result.rc }}. stderr: {{ fetch_secret_result.stderr | default('(none)') }}. stdout: {{ fetch_secret_result.stdout | default('(none)') }}"
      when: fetch_secret_result.rc != 0

    - name: Abort when secret retrieval fails
      fail:
        msg: "Could not read replica set key from Secret Manager (exit {{ fetch_secret_result.rc }}). Check secret '{{ mongo_key_auth_secret }}' in project '{{ gcp_project }}' and IAM for the account running this playbook."
      when: fetch_secret_result.rc != 0

    - name: Persist keyfile on disk
      copy:
        content: "{{ fetch_secret_result.stdout }}"
        dest: /etc/mongo.keyfile
        mode: '0600'
        owner: mongodb
        group: mongodb
      when: fetch_secret_result.rc == 0

    - name: Ensure keyfile exists and is non-empty
      stat:
        path: /etc/mongo.keyfile
      register: keyfile_stat

    - name: Abort when keyfile is missing or empty
      fail:
        msg: "Replica set keyfile at /etc/mongo.keyfile is missing or empty. Verify secret '{{ mongo_key_auth_secret }}' in project '{{ gcp_project }}' and IAM."
      when: keyfile_stat.stat.exists == false or keyfile_stat.stat.size == 0

    - name: Deploy mongod config with auth enabled
      template:
        src: "mongod-{{ mongo_version }}.conf.j2"
        dest: /etc/mongod.conf
        mode: '0644'

    - name: Restart mongod
      service:
        name: mongod
        state: restarted

    - name: Ensure mongod is listening
      wait_for:
        host: "{{ ansible_default_ipv4.address }}"
        port: "{{ mongo_port }}"
        state: started
        delay: 5
  when: not mongo_auth_key.stat.exists or (mongo_auth_key.stat.exists and (mongo_auth_key.stat.size | default(0)) == 0)
