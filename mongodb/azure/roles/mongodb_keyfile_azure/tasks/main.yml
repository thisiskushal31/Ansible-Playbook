---
- name: Check for existing keyfile
  stat:
    path: /etc/mongo.keyfile
  register: mongo_auth_key

- block:
    - name: Retrieve replica set key from Key Vault
      shell: "az keyvault secret show --vault-name {{ azure_keyvault_name }} --name {{ mongo_key_auth_secret }} --query value -o tsv"
      register: fetch_secret_result
      changed_when: true
      no_log: true

    - name: Abort when secret retrieval fails
      fail:
        msg: "Could not read replica set key from Key Vault. Check vault name, secret name, and identity permissions (e.g. Key Vault Secrets User)."
      when: fetch_secret_result.rc != 0

    - name: Persist keyfile on disk
      copy:
        content: "{{ fetch_secret_result.stdout }}"
        dest: /etc/mongo.keyfile
        mode: '0600'
        owner: mongodb
        group: mongodb
      when: fetch_secret_result.rc == 0
      no_log: true

    - name: Deploy mongod config with auth enabled
      template:
        src: "mongod-{{ mongo_version }}.conf.j2"
        dest: /etc/mongod.conf
        mode: '0644'

    - name: Restart mongod
      service:
        name: mongod
        state: restarted

    - name: Ensure mongod is listening
      wait_for:
        host: "{{ ansible_default_ipv4.address }}"
        port: "{{ mongo_port }}"
        state: started
        delay: 5
  when: (not mongo_auth_key.stat.exists) or ((mongo_auth_key.stat.size | default(0)) == 0)
