---
- name: Set node roles list from role flags
  ansible.builtin.set_fact:
    es_node_roles: "{{ (['master', 'data'] if (es_data_master | default(0) | int == 1) else (['master'] if (es_master | default(0) | int == 1) else (['data'] if (es_data | default(0) | int == 1) else []))) + (['ingest'] if (es_ingest | default(0) | int == 1) else []) }}"

- name: Deploy elasticsearch.yml
  ansible.builtin.template:
    src: elasticsearch.yml.j2
    dest: /etc/elasticsearch/elasticsearch.yml
    owner: root
    group: elasticsearch
    mode: "0640"

- name: Restart Elasticsearch to apply config
  ansible.builtin.systemd:
    name: elasticsearch
    state: restarted
  when: es_config_changed | default(true) | bool
